// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// generator client {
//   provider = "prisma-client"
//   output   = "../generated/prisma"
// }

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

model User {
  id          Int        @id @default(autoincrement())
  email       String     @unique
  password    String
  name        String     @db.VarChar(500)
  phoneNumber String?
  avatar      String?
  totpSecret  String?    @db.VarChar(500)
  status      UserStatus @default(INACTIVE)

  roleId        Int
  role          Role           @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  devices       Device[]
  refreshTokens RefreshToken[]
  wallet        Wallet?
  payments      Payment[]

  // audit
  createdById  Int?
  createdBy    User?  @relation("UserCreatedBy", fields: [createdById], references: [id])
  createdUsers User[] @relation("UserCreatedBy")

  updatedById  Int?
  updatedBy    User?  @relation("UserUpdatedBy", fields: [updatedById], references: [id])
  updatedUsers User[] @relation("UserUpdatedBy")

  deletedById  Int?
  deletedBy    User?  @relation("UserDeletedBy", fields: [deletedById], references: [id])
  deletedUsers User[] @relation("UserDeletedBy")

  deletedRoles Role[] @relation("RoleDeletedBy")
  createdRoles Role[] @relation("RoleCreatedBy")
  updatedRoles Role[] @relation("RoleUpdatedBy")

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

////////////////////
/// ROLE & PERMISSION (RBAC)
////////////////////

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique @db.VarChar(500)
  description String       @default("")
  isActive    Boolean      @default(true)
  permissions Permission[]
  users       User[]

  createdById Int?
  createdBy   User? @relation("RoleCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("RoleUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("RoleDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model Permission {
  id   Int    @id @default(autoincrement())
  code String @unique
  name String

  roleId Int
  role   Role @relation(fields: [roleId], references: [id])
}

model RefreshToken {
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  deviceId  Int // Foreign key tới Device
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  expiredAt DateTime
  createdAt DateTime @default(now())
}

////////////////////
/// WALLET
////////////////////

model Wallet {
  userId Int  @id
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  balance   Int      @default(0)
  updatedAt DateTime @updatedAt
}

////////////////////
/// PAYMENT
////////////////////

model Payment {
  id     Int  @id @default(autoincrement())
  userId Int
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount  Int
  status  PaymentStatus
  gateway String

  transactions PaymentTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PaymentTransaction {
  id        Int     @id @default(autoincrement())
  paymentId Int
  payment   Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  type            String // IN / OUT
  amount          Int
  referenceNumber String?

  createdAt DateTime @default(now())
}

////////////////////
/// TOP-UP PACKAGE (OPTIONAL)
////////////////////

model TopUpPackage {
  id       Int     @id @default(autoincrement())
  name     String
  price    Int
  credit   Int
  bonus    Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Device {
  id            Int            @id @default(autoincrement())
  userId        Int
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  userAgent     String
  ip            String
  lastActive    DateTime       @updatedAt // Thay updatedAt bằng lastActive cho ý nghĩa rõ hơn
  createdAt     DateTime       @default(now())
  isActive      Boolean        @default(true) // Trạng thái thiết bị (đang login hay đã logout)
  refreshTokens RefreshToken[] // Liên kết 1-n với RefreshToken
}

model VerificationCode {
  id    Int                  @id @default(autoincrement())
  email String               @db.VarChar(500)
  code  String               @db.VarChar(50)
  type  VerificationCodeType

  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([email,code, type])
  @@index([expiresAt])
}

enum VerificationCodeType {
  REGISTER
  FORGOT_PASSWORD
  LOGIN
  DISABLE_2FA
}
