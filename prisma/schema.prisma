// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// generator client {
//   provider = "prisma-client"
//   output   = "../generated/prisma"
// }

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

model User {
  id          Int        @id @default(autoincrement())
  email       String     @unique
  password    String
  name        String     @db.VarChar(500)
  phoneNumber String?
  avatar      String?
  totpSecret  String?    @db.VarChar(500)
  status      UserStatus @default(INACTIVE)

  roleId        Int
  role          Role           @relation(fields: [roleId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  devices       Device[]
  refreshTokens RefreshToken[]
  wallet        Wallet?
  payments      Payment[]
  topUps        TopUp[]
  creditLogs    CreditLog[]

  // audit
  createdById  Int?
  createdBy    User?  @relation("UserCreatedBy", fields: [createdById], references: [id])
  createdUsers User[] @relation("UserCreatedBy")

  updatedById  Int?
  updatedBy    User?  @relation("UserUpdatedBy", fields: [updatedById], references: [id])
  updatedUsers User[] @relation("UserUpdatedBy")

  deletedById  Int?
  deletedBy    User?  @relation("UserDeletedBy", fields: [deletedById], references: [id])
  deletedUsers User[] @relation("UserDeletedBy")

  deletedRoles Role[] @relation("RoleDeletedBy")
  createdRoles Role[] @relation("RoleCreatedBy")
  updatedRoles Role[] @relation("RoleUpdatedBy")

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

////////////////////
/// ROLE & PERMISSION (RBAC)
////////////////////

model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique @db.VarChar(500)
  description String       @default("")
  isActive    Boolean      @default(true)
  permissions Permission[]
  users       User[]

  createdById Int?
  createdBy   User? @relation("RoleCreatedBy", fields: [createdById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  updatedById Int?
  updatedBy   User? @relation("RoleUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull, onUpdate: NoAction)
  deletedById Int?
  deletedBy   User? @relation("RoleDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull, onUpdate: NoAction)

  deletedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([deletedAt])
}

model Permission {
  id   Int    @id @default(autoincrement())
  code String @unique
  name String

  roleId Int
  role   Role @relation(fields: [roleId], references: [id])
}

model RefreshToken {
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  deviceId  Int // Foreign key tới Device
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  expiredAt DateTime
  createdAt DateTime @default(now())
}

////////////////////
/// WALLET
////////////////////

////////////////////
/// WALLET & CREDITS
////////////////////

model Wallet {
  userId Int  @id
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Số dư hiện tại (tính bằng VND)
  balance      Int      @default(0)
  
  // Số tiền đã nạp tích lũy (tracking)
  totalTopUp   Int      @default(0)
  
  // Số tiền đã sử dụng tích lũy (tracking)
  totalSpent   Int      @default(0)
  
  topUps       TopUp[]
  creditLogs   CreditLog[]
  
  updatedAt    DateTime @updatedAt
}

// Lịch sử nạp tiền của user
model TopUp {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet     Wallet   @relation(fields: [userId], references: [userId], onDelete: Cascade, map: "TopUp_userId_wallet_fkey")
  
  // Số tiền nạp (VND) - Min 200,000 VND
  amount     Int      @db.Integer
  
  // Trạng thái nạp tiền
  status     PaymentStatus @default(PENDING)
  
  // Phương thức thanh toán
  gateway    String   @db.VarChar(100) // BANK_TRANSFER, MOMO, VIETTEL_PAY...
  
  // Reference ID từ payment gateway
  transactionId String? @db.VarChar(255) @unique
  
  // Metadata thêm
  metadata   String?  @db.Text // JSON: thông tin từ gateway
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([userId])
  @@index([status])
}

// Lịch sử trừ credit khi dùng Gemini
model CreditLog {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet     Wallet   @relation(fields: [userId], references: [userId], onDelete: Cascade, map: "CreditLog_userId_wallet_fkey")
  
  amount     Int      @db.Integer
  
  action     String   @db.VarChar(100) 
  
  requestId  String?  @db.VarChar(255)
  
  description String? @db.VarChar(500)
  
  createdAt  DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

model ServicePricing {
  id         Int      @id @default(autoincrement())
  
  action     String   @unique @db.VarChar(100) // GENERATE_IMAGE, UPSCALE...
  
  costAmount Int      @db.Integer // 5000, 10000...
  
  description String? @db.VarChar(500)
  isActive   Boolean  @default(true)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

////////////////////
/// PAYMENT (SePay)
////////////////////

model Payment {
  id        Int           @id @default(autoincrement())
  userId    Int
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // SePay order fields
  orderCode String        @unique @db.VarChar(255) // order_invoice_number từ SePay
  amount    Int           // Số tiền VND
  status    PaymentStatus @default(PENDING)
  
  description String?     @db.Text
  
  // Tracking times
  paidAt    DateTime?     // Thời điểm thanh toán thành công
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  // Relations
  ipnNotifications IpnNotification[]
  
  @@index([userId])
  @@index([status])
  @@index([orderCode])
}

model IpnNotification {
  id               Int      @id @default(autoincrement())
  paymentId        Int?
  payment          Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  
  // SePay IPN fields
  notificationType String   @db.VarChar(100) // ORDER_PAID, TRANSACTION_VOID
  timestamp        BigInt   // Unix timestamp từ SePay
  
  // Order info
  orderId          String   @db.VarChar(255) // SePay internal order ID
  orderStatus      String   @db.VarChar(50)  // CAPTURED, etc.
  orderAmount      String   @db.VarChar(50)
  orderInvoiceNumber String @db.VarChar(255) // orderCode của chúng ta
  
  // Transaction info
  transactionId    String?  @db.VarChar(255)
  paymentMethod    String?  @db.VarChar(100) // BANK_TRANSFER, CARD
  transactionStatus String? @db.VarChar(50)
  transactionAmount String? @db.VarChar(50)
  transactionDate  String?  @db.VarChar(100)
  
  // Raw data for debugging
  rawData          String   @db.Text // Full JSON from SePay
  
  createdAt        DateTime @default(now())
  
  @@index([paymentId])
  @@index([orderInvoiceNumber])
}

model Device {
  id            Int            @id @default(autoincrement())
  userId        Int
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  userAgent     String
  ip            String
  lastActive    DateTime       @updatedAt // Thay updatedAt bằng lastActive cho ý nghĩa rõ hơn
  createdAt     DateTime       @default(now())
  isActive      Boolean        @default(true) // Trạng thái thiết bị (đang login hay đã logout)
  refreshTokens RefreshToken[] // Liên kết 1-n với RefreshToken
}

model VerificationCode {
  id    Int                  @id @default(autoincrement())
  email String               @db.VarChar(500)
  code  String               @db.VarChar(50)
  type  VerificationCodeType

  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([email,code, type])
  @@index([expiresAt])
}

enum VerificationCodeType {
  REGISTER
  FORGOT_PASSWORD
  LOGIN
  DISABLE_2FA
}
