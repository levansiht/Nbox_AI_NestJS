# HÆ°á»›ng Dáº«n TÃ­ch Há»£p Payment Äáº§y Äá»§

## Má»¥c Lá»¥c

1. [Tá»•ng Quan Há»‡ Thá»‘ng](#1-tá»•ng-quan-há»‡-thá»‘ng)
2. [Flow Chi Tiáº¿t](#2-flow-chi-tiáº¿t)
3. [Cáº¥u HÃ¬nh Production](#3-cáº¥u-hÃ¬nh-production)
4. [Setup Sepay Webhook](#4-setup-sepay-webhook)
5. [Cáº¥u HÃ¬nh ENV](#5-cáº¥u-hÃ¬nh-env)
6. [Test API trÃªn Postman](#6-test-api-trÃªn-postman)
7. [Nhiá»‡m Vá»¥ Frontend](#7-nhiá»‡m-vá»¥-frontend)
8. [Troubleshooting](#8-troubleshooting)

---

## 1. Tá»•ng Quan Há»‡ Thá»‘ng

### 1.1. CÃ¡c thÃ nh pháº§n chÃ­nh

| ThÃ nh pháº§n      | Vai trÃ²                                   | CÃ´ng nghá»‡           |
| --------------- | ----------------------------------------- | ------------------- |
| **Backend API** | Xá»­ lÃ½ logic payment, webhook              | NestJS              |
| **Database**    | LÆ°u trá»¯ payment, wallet                   | PostgreSQL + Prisma |
| **VietQR**      | Táº¡o mÃ£ QR thanh toÃ¡n                      | API miá»…n phÃ­        |
| **Sepay**       | Theo dÃµi giao dá»‹ch ngÃ¢n hÃ ng, gá»i webhook | Service tráº£ phÃ­     |
| **Frontend**    | Hiá»ƒn thá»‹ QR, polling status               | React/Vue/...       |

### 1.2. LÃ m sao biáº¿t ngÆ°á»i dÃ¹ng Ä‘Ã£ chuyá»ƒn tiá»n?

**CÃ¢u tráº£ lá»i: ThÃ´ng qua Sepay Webhook**

Sepay lÃ  dá»‹ch vá»¥ káº¿t ná»‘i vá»›i tÃ i khoáº£n ngÃ¢n hÃ ng cá»§a báº¡n. Khi cÃ³ giao dá»‹ch má»›i (ai Ä‘Ã³ chuyá»ƒn tiá»n vÃ o), Sepay sáº½ **tá»± Ä‘á»™ng gá»i webhook** Ä‘áº¿n server cá»§a báº¡n trong vÃ²ng **5-30 giÃ¢y**.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User      â”‚      â”‚  NgÃ¢n hÃ ng  â”‚      â”‚   Sepay     â”‚      â”‚ Your Server â”‚
â”‚  (App Bank) â”‚      â”‚   (MB,VCB)  â”‚      â”‚  (Monitor)  â”‚      â”‚  (NestJS)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚ 1. Chuyá»ƒn tiá»n     â”‚                    â”‚                    â”‚
       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚ 2. Giao dá»‹ch má»›i   â”‚                    â”‚
       â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                    â”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚ 3. POST /webhook   â”‚
       â”‚                    â”‚                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                    â”‚                    â”‚                    â”‚
       â”‚                    â”‚                    â”‚    4. Update DB    â”‚
       â”‚                    â”‚                    â”‚    Payment=SUCCESS â”‚
       â”‚                    â”‚                    â”‚    Wallet += amountâ”‚
       â”‚                    â”‚                    â”‚                    â”‚
```

---

## 2. Flow Chi Tiáº¿t

### 2.1. Flow tá»•ng quan

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                           PAYMENT FLOW HOÃ€N CHá»ˆNH                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘                                                                                â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚ BÆ¯á»šC 1: USER Táº O PAYMENT                                                â”‚  â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â”‚  User nháº­p sá»‘ tiá»n â”€â”€â–º POST /payment/create â”€â”€â–º Server táº¡o Payment     â”‚  â•‘
â•‘  â”‚       500,000Ä‘              (Bearer Token)         status: PENDING      â”‚  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â”‚  Server tráº£ vá»:                                                         â”‚  â•‘
â•‘  â”‚  â€¢ paymentId: 123                                                       â”‚  â•‘
â•‘  â”‚  â€¢ qrCodeUrl: https://img.vietqr.io/...                                â”‚  â•‘
â•‘  â”‚  â€¢ bankInfo: { accountNo, accountName, transferContent: "NBOX123" }    â”‚  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘                                    â”‚                                          â•‘
â•‘                                    â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚ BÆ¯á»šC 2: USER QUÃ‰T QR & CHUYá»‚N TIá»€N                                      â”‚  â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â”‚  Frontend hiá»ƒn thá»‹ QR â”€â”€â–º User má»Ÿ app ngÃ¢n hÃ ng â”€â”€â–º QuÃ©t QR            â”‚  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â”‚  App ngÃ¢n hÃ ng tá»± Ä‘á»™ng Ä‘iá»n:                                           â”‚  â•‘
â•‘  â”‚  â€¢ Sá»‘ tÃ i khoáº£n: 0344490123456                                         â”‚  â•‘
â•‘  â”‚  â€¢ Sá»‘ tiá»n: 500,000Ä‘                                                   â”‚  â•‘
â•‘  â”‚  â€¢ Ná»™i dung: NBOX123  â—„â”€â”€ QUAN TRá»ŒNG: ÄÃ¢y lÃ  cÃ¡ch nháº­n diá»‡n payment   â”‚  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â”‚  User xÃ¡c nháº­n chuyá»ƒn tiá»n                                              â”‚  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘                                    â”‚                                          â•‘
â•‘                                    â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚ BÆ¯á»šC 3: SEPAY NHáº¬N BIáº¾T GIAO Dá»ŠCH & Gá»ŒI WEBHOOK                        â”‚  â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â”‚  NgÃ¢n hÃ ng nháº­n tiá»n â”€â”€â–º Sepay detect (5-30s) â”€â”€â–º POST /payment/receiverâ•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â”‚  Sepay gá»­i Ä‘áº¿n server:                                                  â”‚  â•‘
â•‘  â”‚  {                                                                      â”‚  â•‘
â•‘  â”‚    "content": "NBOX123 chuyen tien",  â—„â”€â”€ Server parse ra paymentId=123â•‘
â•‘  â”‚    "transferAmount": 500000,                                            â”‚  â•‘
â•‘  â”‚    "transferType": "in",                                                â”‚  â•‘
â•‘  â”‚    ...                                                                  â”‚  â•‘
â•‘  â”‚  }                                                                      â”‚  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘                                    â”‚                                          â•‘
â•‘                                    â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚ BÆ¯á»šC 4: SERVER Xá»¬ LÃ WEBHOOK                                            â”‚  â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â”‚  Server thá»±c hiá»‡n:                                                      â”‚  â•‘
â•‘  â”‚  1. Parse paymentId tá»« content: "NBOX123" â†’ paymentId = 123            â”‚  â•‘
â•‘  â”‚  2. TÃ¬m Payment vá»›i id = 123                                           â”‚  â•‘
â•‘  â”‚  3. Kiá»ƒm tra sá»‘ tiá»n: transferAmount >= payment.amount                 â”‚  â•‘
â•‘  â”‚  4. Cáº­p nháº­t Payment: status = "SUCCESS"                               â”‚  â•‘
â•‘  â”‚  5. Cáº­p nháº­t Wallet: balance += transferAmount                         â”‚  â•‘
â•‘  â”‚  6. Táº¡o TopUp record Ä‘á»ƒ tracking                                       â”‚  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘                                    â”‚                                          â•‘
â•‘                                    â–¼                                          â•‘
â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘
â•‘  â”‚ BÆ¯á»šC 5: FRONTEND BIáº¾T PAYMENT THÃ€NH CÃ”NG (POLLING)                     â”‚  â•‘
â•‘  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â”‚  Frontend polling má»—i 5s â”€â”€â–º GET /payment/123 â”€â”€â–º status: "SUCCESS"    â”‚  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â”‚  Khi status = SUCCESS:                                                  â”‚  â•‘
â•‘  â”‚  â€¢ Dá»«ng polling                                                         â”‚  â•‘
â•‘  â”‚  â€¢ Hiá»ƒn thá»‹ thÃ´ng bÃ¡o "Náº¡p tiá»n thÃ nh cÃ´ng!"                           â”‚  â•‘
â•‘  â”‚  â€¢ Redirect Ä‘áº¿n trang wallet hoáº·c Ä‘Ã³ng modal                           â”‚  â•‘
â•‘  â”‚  â€¢ Refresh wallet balance                                               â”‚  â•‘
â•‘  â”‚                                                                         â”‚  â•‘
â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘
â•‘                                                                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 2.2. CÃ¡ch Frontend biáº¿t Ä‘á»ƒ redirect

**Frontend KHÃ”NG nháº­n Ä‘Æ°á»£c thÃ´ng bÃ¡o trá»±c tiáº¿p tá»« server.** Thay vÃ o Ä‘Ã³, FE sá»­ dá»¥ng **Polling**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    POLLING MECHANISM                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Frontend                              Backend                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â”‚ GET /payment/123                   â”‚                     â”‚
â”‚   t=0 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                     â”‚
â”‚       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€ status: PENDING â”€â”€â”€â”€â”€â”€â”€ â”‚                     â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â”‚ (chá» 5 giÃ¢y)                       â”‚                     â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â”‚ GET /payment/123                   â”‚                     â”‚
â”‚   t=5 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                     â”‚
â”‚       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€ status: PENDING â”€â”€â”€â”€â”€â”€â”€ â”‚                     â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â”‚ (chá» 5 giÃ¢y)                       â”‚ â—„â”€â”€ Webhook tá»« Sepayâ”‚
â”‚       â”‚                                    â”‚     Payment=SUCCESS â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â”‚ GET /payment/123                   â”‚                     â”‚
â”‚  t=10 â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                     â”‚
â”‚       â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€ status: SUCCESS â”€â”€â”€â”€â”€â”€â”€ â”‚                     â”‚
â”‚       â”‚                                    â”‚                     â”‚
â”‚       â”‚ â˜… REDIRECT / SHOW SUCCESS â˜…        â”‚                     â”‚
â”‚       â”‚                                    â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Táº¡i sao dÃ¹ng Polling thay vÃ¬ WebSocket?**

- ÄÆ¡n giáº£n, dá»… implement
- KhÃ´ng cáº§n maintain connection
- Payment thÆ°á»ng hoÃ n thÃ nh trong 1-2 phÃºt
- Polling má»—i 5s = tá»‘i Ä‘a 12-24 requests cho 1 payment

---

## 3. Cáº¥u HÃ¬nh Production

### 3.1. YÃªu cáº§u Ä‘á»ƒ deploy production

| YÃªu cáº§u                 | MÃ´ táº£                                  | Báº¯t buá»™c |
| ----------------------- | -------------------------------------- | -------- |
| **HTTPS**               | Sepay chá»‰ gá»i webhook Ä‘áº¿n URL https    | âœ…       |
| **Domain**              | Cáº§n domain tháº­t (khÃ´ng dÃ¹ng localhost) | âœ…       |
| **Sepay Account**       | ÄÄƒng kÃ½ vÃ  liÃªn káº¿t ngÃ¢n hÃ ng          | âœ…       |
| **TÃ i khoáº£n ngÃ¢n hÃ ng** | Äá»ƒ nháº­n tiá»n                           | âœ…       |

### 3.2. CÃ¡c bÆ°á»›c deploy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PRODUCTION DEPLOYMENT                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  BÆ¯á»šC 1: CHUáº¨N Bá»Š INFRASTRUCTURE                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚  â€¢ Mua domain: vÃ­ dá»¥ api.nbox.vn                                â”‚
â”‚  â€¢ Setup VPS/Cloud: AWS, GCP, DigitalOcean, Vercel...          â”‚
â”‚  â€¢ Cáº¥u hÃ¬nh SSL certificate (Let's Encrypt miá»…n phÃ­)           â”‚
â”‚                                                                  â”‚
â”‚  BÆ¯á»šC 2: DEPLOY BACKEND                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â€¢ Push code lÃªn server                                         â”‚
â”‚  â€¢ Set environment variables                                    â”‚
â”‚  â€¢ Cháº¡y: npm run build && npm run start:prod                   â”‚
â”‚  â€¢ Äáº£m báº£o endpoint: https://api.nbox.vn/payment/receiver      â”‚
â”‚                                                                  â”‚
â”‚  BÆ¯á»šC 3: ÄÄ‚NG KÃ SEPAY                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚  â€¢ Truy cáº­p: https://my.sepay.vn                               â”‚
â”‚  â€¢ ÄÄƒng kÃ½ tÃ i khoáº£n                                           â”‚
â”‚  â€¢ LiÃªn káº¿t ngÃ¢n hÃ ng (MB, VCB, TCB...)                        â”‚
â”‚  â€¢ Cáº¥u hÃ¬nh webhook URL                                         â”‚
â”‚                                                                  â”‚
â”‚  BÆ¯á»šC 4: TEST                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  â€¢ Chuyá»ƒn khoáº£n sá»‘ tiá»n nhá» (10,000Ä‘)                          â”‚
â”‚  â€¢ Kiá»ƒm tra webhook cÃ³ Ä‘Æ°á»£c gá»i khÃ´ng                          â”‚
â”‚  â€¢ Verify database Ä‘Æ°á»£c cáº­p nháº­t                               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3. VÃ­ dá»¥ deploy lÃªn cÃ¡c platform

**Option 1: Railway (Recommended cho NestJS)**

1. Push code lÃªn GitHub
2. Truy cáº­p https://railway.app
3. Connect GitHub repo
4. Add PostgreSQL database
5. Set environment variables
6. Deploy â†’ Nháº­n URL: https://your-app.railway.app

**Option 2: Render**

1. https://render.com
2. New Web Service â†’ Connect GitHub
3. Build command: `npm install && npm run build`
4. Start command: `npm run start:prod`

**Option 3: VPS (DigitalOcean, Vultr)**

1. Mua VPS Ubuntu
2. Install Node.js, PM2, Nginx
3. Clone repo, setup env
4. Nginx reverse proxy + SSL

---

## 4. Setup Sepay Webhook

### 4.1. ÄÄƒng kÃ½ Sepay

1. Truy cáº­p **https://my.sepay.vn**
2. ÄÄƒng kÃ½ tÃ i khoáº£n (email, sá»‘ Ä‘iá»‡n thoáº¡i)
3. XÃ¡c thá»±c tÃ i khoáº£n

### 4.2. LiÃªn káº¿t ngÃ¢n hÃ ng

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SEPAY DASHBOARD                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. VÃ o má»¥c "NgÃ¢n hÃ ng" â†’ "ThÃªm ngÃ¢n hÃ ng"                      â”‚
â”‚                                                                  â”‚
â”‚  2. Chá»n ngÃ¢n hÃ ng cá»§a báº¡n (MB, VCB, TCB...)                   â”‚
â”‚                                                                  â”‚
â”‚  3. ÄÄƒng nháº­p vÃ o tÃ i khoáº£n ngÃ¢n hÃ ng                          â”‚
â”‚     (Sepay sáº½ read-only, KHÃ”NG thá»ƒ chuyá»ƒn tiá»n Ä‘i)             â”‚
â”‚                                                                  â”‚
â”‚  4. XÃ¡c nháº­n liÃªn káº¿t                                           â”‚
â”‚                                                                  â”‚
â”‚  âš ï¸  LÆ°u Ã½: Má»™t sá»‘ ngÃ¢n hÃ ng cáº§n xÃ¡c thá»±c thÃªm qua OTP/email    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3. Cáº¥u hÃ¬nh Webhook

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WEBHOOK CONFIGURATION                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. VÃ o má»¥c "CÃ i Ä‘áº·t" â†’ "Webhook"                               â”‚
â”‚                                                                  â”‚
â”‚  2. ThÃªm webhook má»›i:                                           â”‚
â”‚                                                                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚     â”‚ URL Webhook:                                         â”‚     â”‚
â”‚     â”‚ https://api.your-domain.com/payment/receiver        â”‚     â”‚
â”‚     â”‚                                                      â”‚     â”‚
â”‚     â”‚ Method: POST                                         â”‚     â”‚
â”‚     â”‚                                                      â”‚     â”‚
â”‚     â”‚ Headers:                                             â”‚     â”‚
â”‚     â”‚ Authorization: Apikey YOUR_PAYMENT_API_KEY          â”‚     â”‚
â”‚     â”‚ Content-Type: application/json                       â”‚     â”‚
â”‚     â”‚                                                      â”‚     â”‚
â”‚     â”‚ Events: [âœ“] Giao dá»‹ch má»›i                           â”‚     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                  â”‚
â”‚  3. LÆ°u cáº¥u hÃ¬nh                                                â”‚
â”‚                                                                  â”‚
â”‚  4. Test webhook (Sepay cÃ³ nÃºt "Test" Ä‘á»ƒ gá»­i sample request)   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4. Sepay sáº½ gá»­i gÃ¬ Ä‘áº¿n server?

Khi cÃ³ giao dá»‹ch má»›i, Sepay POST Ä‘áº¿n URL cá»§a báº¡n vá»›i body:

```json
{
  "id": 93,
  "gateway": "MBBank",
  "transactionDate": "2024-12-30 09:58:57",
  "accountNumber": "0344490123456",
  "code": null,
  "content": "NBOX123 chuyen tien",
  "transferType": "in",
  "transferAmount": 500000,
  "accumulated": 1500000,
  "subAccount": null,
  "referenceCode": "FT24365ABC123",
  "description": "NBOX123 chuyen tien"
}
```

**Server cá»§a báº¡n sáº½:**

1. Parse `content` â†’ TÃ¬m "NBOX123" â†’ paymentId = 123
2. TÃ¬m Payment vá»›i id = 123
3. Cáº­p nháº­t status = SUCCESS
4. Cá»™ng tiá»n vÃ o wallet

---

## 5. Cáº¥u HÃ¬nh ENV

### 5.1. CÃ¡c biáº¿n cáº§n thiáº¿t

```env
# ===================================
# PAYMENT CONFIGURATION
# ===================================

# API Key Ä‘á»ƒ xÃ¡c thá»±c webhook tá»« Sepay
# Báº¡n tá»± táº¡o 1 chuá»—i random hoáº·c láº¥y tá»« Sepay dashboard
PAYMENT_API_KEY=sk_live_abc123xyz456789

# ThÃ´ng tin tÃ i khoáº£n ngÃ¢n hÃ ng NHáº¬N TIá»€N
BANK_ID=MB                          # MÃ£ ngÃ¢n hÃ ng
BANK_ACCOUNT_NO=0344490123456       # Sá»‘ tÃ i khoáº£n
BANK_ACCOUNT_NAME=NGUYEN VAN A      # TÃªn chá»§ TK (KHÃ”NG Dáº¤U, IN HOA)

# Prefix cho ná»™i dung chuyá»ƒn khoáº£n
PAYMENT_DESCRIPTION_PREFIX=NBOX     # Káº¿t quáº£: NBOX1, NBOX2, NBOX123...
```

### 5.2. Báº£ng mÃ£ ngÃ¢n hÃ ng

| BANK_ID | NgÃ¢n hÃ ng   | BANK_ID | NgÃ¢n hÃ ng   |
| ------- | ----------- | ------- | ----------- |
| `MB`    | MB Bank     | `VCB`   | Vietcombank |
| `TCB`   | Techcombank | `ACB`   | ACB         |
| `BIDV`  | BIDV        | `VPB`   | VPBank      |
| `TPB`   | TPBank      | `VIB`   | VIB         |

### 5.3. LÆ°u Ã½ quan trá»ng

| Biáº¿n                | YÃªu cáº§u                                                           |
| ------------------- | ----------------------------------------------------------------- |
| `BANK_ACCOUNT_NAME` | **KHÃ”NG Dáº¤U, IN HOA** (VD: `NGUYEN VAN A` thay vÃ¬ `Nguyá»…n VÄƒn A`) |
| `PAYMENT_API_KEY`   | Pháº£i khá»›p vá»›i key cáº¥u hÃ¬nh trÃªn Sepay                             |
| `BANK_ACCOUNT_NO`   | Sá»‘ tÃ i khoáº£n Ä‘Ã£ liÃªn káº¿t vá»›i Sepay                                |

---

## 6. Test API trÃªn Postman

### BÆ°á»›c 1: ÄÄƒng nháº­p

```
POST {{base_url}}/auth/login
Content-Type: application/json

Body: { "email": "...", "password": "..." }
```

â†’ LÆ°u `accessToken`

### BÆ°á»›c 2: Táº¡o Payment

```
POST {{base_url}}/payment/create
Authorization: Bearer {{accessToken}}
Content-Type: application/json

Body: { "amount": 500000 }
```

â†’ LÆ°u `paymentId`, má»Ÿ `qrCodeUrl` trong browser

### BÆ°á»›c 3: Giáº£ láº­p Webhook (Ä‘á»ƒ test)

```
POST {{base_url}}/payment/receiver
Authorization: Apikey {{PAYMENT_API_KEY}}
Content-Type: application/json

Body: {
  "id": 12345,
  "gateway": "MB",
  "transactionDate": "2024-12-30 14:35:00",
  "accountNumber": "0344490123456",
  "code": null,
  "content": "NBOX1",
  "transferType": "in",
  "transferAmount": 500000,
  "accumulated": 500000,
  "subAccount": null,
  "referenceCode": "FT24365ABC123",
  "description": "NBOX1"
}
```

### BÆ°á»›c 4: Verify Payment Status

```
GET {{base_url}}/payment/1
Authorization: Bearer {{accessToken}}
```

â†’ Kiá»ƒm tra `status: "SUCCESS"`

---

## 7. Nhiá»‡m Vá»¥ Frontend

### 7.1. TÃ³m táº¯t nhiá»‡m vá»¥

| STT | Nhiá»‡m vá»¥                            | API                         |
| --- | ----------------------------------- | --------------------------- |
| 1   | Form nháº­p sá»‘ tiá»n                   | -                           |
| 2   | Gá»i API táº¡o payment                 | `POST /payment/create`      |
| 3   | Hiá»ƒn thá»‹ QR tá»« `qrCodeUrl`          | -                           |
| 4   | Hiá»ƒn thá»‹ thÃ´ng tin chuyá»ƒn khoáº£n     | -                           |
| 5   | Button copy ná»™i dung CK             | -                           |
| 6   | **Polling status má»—i 5s**           | `GET /payment/{id}`         |
| 7   | Khi SUCCESS â†’ Redirect/Show message | -                           |
| 8   | Button há»§y giao dá»‹ch                | `POST /payment/{id}/cancel` |

### 7.2. Flow Frontend chi tiáº¿t

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND FLOW                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  SCREEN 1: NHáº¬P Sá» TIá»€N                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   ğŸ’° Náº¡p tiá»n vÃ o vÃ­                                      â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   Chá»n nhanh:                                            â”‚  â”‚
â”‚  â”‚   [50K] [100K] [200K] [500K] [1M]                        â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   Hoáº·c nháº­p sá»‘ tiá»n: [___________] VND                   â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   [     Táº O MÃƒ QR THANH TOÃN     ]                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼ (Gá»i POST /payment/create)          â”‚
â”‚                                                                  â”‚
â”‚  SCREEN 2: HIá»‚N THá»Š QR                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   ğŸ“± QuÃ©t mÃ£ QR Ä‘á»ƒ thanh toÃ¡n                            â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚  â”‚
â”‚  â”‚        â”‚                 â”‚                               â”‚  â”‚
â”‚  â”‚        â”‚    [QR CODE]    â”‚                               â”‚  â”‚
â”‚  â”‚        â”‚                 â”‚                               â”‚  â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   NgÃ¢n hÃ ng: MB Bank                                     â”‚  â”‚
â”‚  â”‚   Sá»‘ TK: 0344490123456                                   â”‚  â”‚
â”‚  â”‚   Chá»§ TK: NGUYEN VAN A                                   â”‚  â”‚
â”‚  â”‚   Sá»‘ tiá»n: 500,000Ä‘                                      â”‚  â”‚
â”‚  â”‚   Ná»™i dung: NBOX1 [Copy]                                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   â³ Äang chá» thanh toÃ¡n... (Tá»± Ä‘á»™ng kiá»ƒm tra)           â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   [     Há»¦Y GIAO Dá»ŠCH     ]                              â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â”‚ (Polling GET /payment/{id} má»—i 5s)  â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼ (Khi status = SUCCESS)              â”‚
â”‚                                                                  â”‚
â”‚  SCREEN 3: THÃ€NH CÃ”NG                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   âœ… Náº¡p tiá»n thÃ nh cÃ´ng!                                â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   Sá»‘ tiá»n: 500,000Ä‘                                      â”‚  â”‚
â”‚  â”‚   Sá»‘ dÆ° má»›i: 1,500,000Ä‘                                  â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚   [     Vá»€ TRANG CHá»¦     ]                               â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3. Polling Logic

```
START
  â”‚
  â–¼
Gá»i GET /payment/{id}
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ status = ?      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚            â”‚
    â–¼         â–¼            â–¼
 PENDING   SUCCESS    CANCELLED/FAILED
    â”‚         â”‚            â”‚
    â–¼         â–¼            â–¼
 Wait 5s   STOP       STOP
    â”‚      Polling    Polling
    â”‚         â”‚            â”‚
    â”‚         â–¼            â–¼
    â”‚      Redirect    Show Error
    â”‚      + Refresh
    â”‚      Wallet
    â”‚
    â””â”€â”€â”€â”€â”€â”€â–º Loop back to START
```

---

## 8. Troubleshooting

### 8.1. Lá»—i thÆ°á»ng gáº·p

| Lá»—i                    | NguyÃªn nhÃ¢n                    | Giáº£i phÃ¡p                             |
| ---------------------- | ------------------------------ | ------------------------------------- |
| QR khÃ´ng hiá»ƒn thá»‹      | ENV thiáº¿u `BANK_ACCOUNT_NO`    | ThÃªm Ä‘áº§y Ä‘á»§ ENV                       |
| Webhook khÃ´ng Ä‘Æ°á»£c gá»i | URL khÃ´ng pháº£i HTTPS           | Deploy lÃªn server cÃ³ SSL              |
| Payment khÃ´ng SUCCESS  | Ná»™i dung CK khÃ´ng Ä‘Ãºng         | User pháº£i giá»¯ nguyÃªn ná»™i dung         |
| "Invalid payment ID"   | KhÃ´ng parse Ä‘Æ°á»£c ID tá»« content | Kiá»ƒm tra `PAYMENT_DESCRIPTION_PREFIX` |

### 8.2. CÃ¡ch debug webhook

1. **Kiá»ƒm tra Sepay dashboard** â†’ Xem lá»‹ch sá»­ webhook calls
2. **ThÃªm logging trong server**:
   - Log request body khi nháº­n webhook
   - Log cÃ¡c bÆ°á»›c xá»­ lÃ½
3. **DÃ¹ng ngrok Ä‘á»ƒ test local**:
   - `ngrok http 3000`
   - URL: `https://abc123.ngrok.io/payment/receiver`

---

## 9. TÃ i Liá»‡u Tham Kháº£o

| TÃ i liá»‡u      | URL                            |
| ------------- | ------------------------------ |
| VietQR API    | https://vietqr.io              |
| Sepay Docs    | https://docs.sepay.vn          |
| NestJS Guards | https://docs.nestjs.com/guards |
| Prisma ORM    | https://www.prisma.io/docs     |
